name: Dynamic YouTube Channel Discovery & Analysis

on:
  schedule:
    - cron: '0 15,21,3,9 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  collect:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install packages
        run: |
          npm init -y
          npm install googleapis@105.0.0
      
      - name: Create directories
        run: |
          mkdir -p data
          mkdir -p data/backup
          mkdir -p data/daily
      
      - name: Run collection
        env:
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
        run: |
          echo "Starting collection at $(date)"
          node scripts/collect-dynamic.js
          
          if [ -f "data/latest.json" ]; then
            echo "Collection successful"
            ls -lh data/latest.json
          fi
      
      - name: Backup data
        if: success()
        run: |
          if [ -f "data/latest.json" ]; then
            cp data/latest.json "data/backup/$(date +%Y%m%d_%H%M%S).json"
            cp data/latest.json "data/daily/$(date +%Y-%m-%d).json"
            echo "Backup created"
            
            # 오래된 백업 정리
            find data/backup -name "*.json" -mtime +7 -delete 2>/dev/null || true
            find data/daily -name "*.json" -mtime +30 -delete 2>/dev/null || true
          fi
      
      - name: Generate summary
        if: success()
        run: |
          if [ -f "data/latest.json" ]; then
            node -e "
              const fs = require('fs');
              const data = JSON.parse(fs.readFileSync('data/latest.json'));
              const summary = {
                timestamp: new Date().toISOString(),
                channels: data.channels?.length || 0,
                videos: data.videos?.length || 0,
                shorts: data.statistics?.totalShorts || 0
              };
              fs.writeFileSync('data/summary.json', JSON.stringify(summary, null, 2));
              console.log('Summary created:', summary);
            "
          fi
      
      - name: Commit data
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          git add data/
          
          if git diff --staged --quiet; then
            echo "No changes"
          else
            CHANNELS=$(node -e "const d=require('./data/latest.json'); console.log(d.channels?.length || 0)" 2>/dev/null || echo "0")
            VIDEOS=$(node -e "const d=require('./data/latest.json'); console.log(d.videos?.length || 0)" 2>/dev/null || echo "0")
            
            git commit -m "Update: $CHANNELS channels, $VIDEOS videos - $(date)"
            git push
          fi
