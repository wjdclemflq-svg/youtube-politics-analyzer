name: Dynamic YouTube Politics Collector

on:
  schedule:
    # 6ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰ (í•œêµ­ì‹œê°„ ê¸°ì¤€ 0ì‹œ, 6ì‹œ, 12ì‹œ, 18ì‹œ)
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      channel_limit:
        description: 'Maximum number of channels to analyze'
        required: false
        default: '50'
        type: string
      debug_mode:
        description: 'Enable debug logging'
        required: false
        default: 'false'
        type: boolean
      force_discovery:
        description: 'Force new channel discovery'
        required: false
        default: 'false'
        type: boolean

jobs:
  collect-and-analyze:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: |
          npm init -y
          npm install googleapis
      
      - name: Set environment variables
        run: |
          echo "YOUTUBE_API_KEY=${{ secrets.YOUTUBE_API_KEY }}" >> $GITHUB_ENV
          echo "CHANNEL_LIMIT=${{ github.event.inputs.channel_limit || '50' }}" >> $GITHUB_ENV
          echo "DEBUG_MODE=${{ github.event.inputs.debug_mode || 'false' }}" >> $GITHUB_ENV
          echo "FORCE_DISCOVERY=${{ github.event.inputs.force_discovery || 'false' }}" >> $GITHUB_ENV
      
      - name: Check API Key
        run: |
          if [ -z "$YOUTUBE_API_KEY" ]; then
            echo "âŒ YouTube API Key is not set!"
            exit 1
          else
            echo "âœ… YouTube API Key is configured"
          fi
      
      - name: Discover Channels (Conditional)
        id: discover
        run: |
          # ì±„ë„ íŒŒì¼ì´ ì—†ê±°ë‚˜ ê°•ì œ ë°œê²¬ ëª¨ë“œì¼ ë•Œë§Œ ì‹¤í–‰
          if [ ! -f "data/channels.json" ] || [ "$FORCE_DISCOVERY" == "true" ]; then
            echo "ğŸ” Discovering channels..."
            node scripts/discover-channels.js
          else
            # íŒŒì¼ì´ 24ì‹œê°„ ì´ìƒ ë˜ì—ˆìœ¼ë©´ ì—…ë°ì´íŠ¸
            if [ -f "data/channels.json" ]; then
              last_modified=$(stat -c %Y data/channels.json 2>/dev/null || stat -f %m data/channels.json)
              current_time=$(date +%s)
              age=$((current_time - last_modified))
              
              # 24ì‹œê°„ = 86400ì´ˆ
              if [ $age -gt 86400 ]; then
                echo "ğŸ“Š Channel list is older than 24 hours, updating..."
                node scripts/discover-channels.js
              else
                echo "âœ… Using existing channel list (updated $(($age / 3600)) hours ago)"
              fi
            fi
          fi
      
      - name: Analyze Videos and Shorts
        run: |
          echo "ğŸ“¹ Analyzing videos and shorts..."
          node scripts/analyze-videos.js
      
      - name: Generate Statistics
        run: |
          echo "ğŸ“Š Generating statistics..."
          if [ -f "data/summary.json" ]; then
            echo "Summary statistics:"
            cat data/summary.json | jq '.'
          fi
      
      - name: Create Backup
        run: |
          # ì‹œê°„ë³„ ë°±ì—…
          timestamp=$(date +%Y%m%d_%H%M%S)
          mkdir -p data/backup
          
          if [ -f "data/latest.json" ]; then
            cp data/latest.json "data/backup/latest_${timestamp}.json"
          fi
          
          # ì¼ì¼ ë°±ì—… (í•˜ë£¨ì— í•œ ë²ˆë§Œ)
          daily_backup="data/daily/$(date +%Y%m%d).json"
          mkdir -p data/daily
          
          if [ ! -f "$daily_backup" ] && [ -f "data/latest.json" ]; then
            cp data/latest.json "$daily_backup"
            echo "ğŸ“ Created daily backup: $daily_backup"
          fi
          
          # ì˜¤ë˜ëœ ë°±ì—… ì •ë¦¬ (7ì¼ ì´ìƒ)
          find data/backup -name "*.json" -mtime +7 -delete 2>/dev/null || true
          find data/daily -name "*.json" -mtime +30 -delete 2>/dev/null || true
      
      - name: Update Dashboard Data
        run: |
          # index.htmlì´ ìˆë‹¤ë©´ ìµœì‹  ë°ì´í„°ë¡œ ì—…ë°ì´íŠ¸
          if [ -f "index.html" ]; then
            echo "ğŸŒ Dashboard will use latest data from data/latest.json"
          fi
          
          # í†µê³„ ìš”ì•½ ìƒì„±
          if [ -f "data/summary.json" ]; then
            echo "ğŸ“ˆ Current Statistics:"
            echo "========================"
            jq -r '
              "Channels Analyzed: \(.totalChannelsAnalyzed)",
              "Total Videos: \(.totalVideos)",
              "Total Shorts: \(.totalShorts)",
              "Total Views: \(.totalViewCount | tostring | tonumber | . / 1000000 | floor)M",
              "Average Views per Short: \(.averageViewsPerShort)"
            ' data/summary.json
          fi
      
      - name: Commit and Push Changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # ë³€ê²½ì‚¬í•­ í™•ì¸
          if [ -n "$(git status --porcelain)" ]; then
            git add data/
            
            # ì»¤ë°‹ ë©”ì‹œì§€ì— í†µê³„ í¬í•¨
            if [ -f "data/summary.json" ]; then
              channels=$(jq -r '.totalChannelsAnalyzed' data/summary.json)
              videos=$(jq -r '.totalVideos' data/summary.json)
              shorts=$(jq -r '.totalShorts' data/summary.json)
              commit_msg="ğŸ¬ Update: ${channels} channels, ${videos} videos, ${shorts} shorts"
            else
              commit_msg="ğŸ“Š Update YouTube politics data"
            fi
            
            git commit -m "$commit_msg" -m "Last updated: $(date)"
            git push
            
            echo "âœ… Successfully pushed updates"
          else
            echo "â„¹ï¸ No changes to commit"
          fi
      
      - name: Check API Quota Usage
        if: always()
        run: |
          echo "ğŸ“Š Estimated API Quota Usage:"
          echo "================================"
          
          # ì˜ˆìƒ API ì‚¬ìš©ëŸ‰ ê³„ì‚°
          channels_checked="${CHANNEL_LIMIT:-50}"
          
          # search.list: 100 units per call
          # channels.list: 1 unit per call  
          # playlistItems.list: 1 unit per call
          # videos.list: 1 unit per call
          
          search_calls=15  # ê²€ìƒ‰ì–´ ìˆ˜
          channel_calls=$channels_checked
          playlist_calls=$channels_checked
          video_calls=$((channels_checked * 2))  # ì±„ë„ë‹¹ 2ë²ˆ í˜¸ì¶œ ì˜ˆìƒ
          
          search_units=$((search_calls * 100))
          channel_units=$channel_calls
          playlist_units=$playlist_calls
          video_units=$video_calls
          
          total_units=$((search_units + channel_units + playlist_units + video_units))
          
          echo "Search API calls: $search_calls (${search_units} units)"
          echo "Channel API calls: $channel_calls (${channel_units} units)"
          echo "Playlist API calls: $playlist_calls (${playlist_units} units)"
          echo "Video API calls: $video_calls (${video_units} units)"
          echo "--------------------------------"
          echo "Total estimated units: ${total_units} / 10,000 daily quota"
          echo "Usage: $((total_units * 100 / 10000))%"
          
          if [ $total_units -gt 10000 ]; then
            echo "âš ï¸ WARNING: Estimated usage exceeds daily quota!"
          else
            echo "âœ… Within daily quota limits"
          fi
      
      - name: Create Issue on Failure
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            const issueTitle = `ğŸš¨ YouTube Collector Failed - ${new Date().toISOString()}`;
            const issueBody = `
            The YouTube Politics Collector workflow failed.
            
            **Workflow Run:** [${context.runNumber}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            **Time:** ${new Date().toISOString()}
            **Error:** Check the workflow logs for details.
            
            **Possible causes:**
            - YouTube API quota exceeded
            - API key issues
            - Network connectivity problems
            - Script errors
            
            Please investigate and fix the issue.
            `;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: issueTitle,
              body: issueBody,
              labels: ['bug', 'automation']
            });
