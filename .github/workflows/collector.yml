name: Optimized YouTube Data Collection

on:
  schedule:
    - cron: '0 21 * * *'  # ì˜¤ì „ 6ì‹œ
    - cron: '0 5 * * *'   # ì˜¤í›„ 2ì‹œ
    - cron: '0 13 * * *'  # ì˜¤í›„ 10ì‹œ
    - cron: '0 1 * * 0'   # ì¼ìš”ì¼ ì˜¤ì „ 10ì‹œ
    
  workflow_dispatch:
    inputs:
      collection_mode:
        description: 'Collection mode'
        required: false
        default: 'smart'
        type: choice
        options:
          - smart
          - light
          - full

jobs:
  collect-data:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - run: npm install
    
    - name: Determine mode
      id: mode
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "mode=${{ github.event.inputs.collection_mode }}" >> $GITHUB_OUTPUT
        else
          HOUR=$(date +%H)
          DAY=$(date +%u)
          if [ "$DAY" -eq 7 ]; then
            echo "mode=full" >> $GITHUB_OUTPUT
          elif [ "$HOUR" -lt 12 ]; then
            echo "mode=light" >> $GITHUB_OUTPUT
          else
            echo "mode=smart" >> $GITHUB_OUTPUT
          fi
        fi
    
    - name: Collect data
      env:
        YOUTUBE_API_KEY1: ${{ secrets.YOUTUBE_API_KEY1 }}
        YOUTUBE_API_KEY2: ${{ secrets.YOUTUBE_API_KEY2 }}
        YOUTUBE_API_KEY3: ${{ secrets.YOUTUBE_API_KEY3 }}
      run: node scripts/collect.js --mode=${{ steps.mode.outputs.mode }}
    
    - run: node scripts/merge.js
    
    - name: Commit changes
      run: |
        git config user.name "GitHub Action"
        git config user.email "action@github.com"
        git add data/
        git diff --staged --quiet || git commit -m "ðŸ“Š Data update: ${{ steps.mode.outputs.mode }} collection"
        git push
